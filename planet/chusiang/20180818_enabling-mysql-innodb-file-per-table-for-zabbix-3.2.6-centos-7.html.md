---
title: "Enabling the InnoDB File-Per-Table tablespaces and migrate the MySQL database for Zabbix 3.2.6 on CentOS 7"
date: 2018-08-18
type: blog
author: 凍仁翔
link: http://note.drx.tw/2018/08/enabling-mysql-innodb-file-per-table-for-zabbix-3.2.6-centos-7.html
layout: post
comments: true
---

As the <b>Zabbix Ops</b>, we want to <b>split the large <i>ibdata1</i> file</b>, so than <b>we can reduce the obsolete data like <i>history_uint</i> table</b>.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ ls -lh /var/lib/mysql/ <span class="Ctrl">[Enter]</span><br /><pre>total 16G<br />-rw-rw---- 1 mysql mysql  16K Aug 15 10:36 aria_log.00000001<br />-rw-rw---- 1 mysql mysql   52 Aug 15 10:36 aria_log_control<br />-rw-rw---- 1 mysql mysql  15G Aug 15 12:45 ibdata1<br />-rw-rw---- 1 mysql mysql 5.0M Aug 15 12:45 ib_logfile0<br />-rw-rw---- 1 mysql mysql 5.0M Aug 15 12:45 ib_logfile1<br />drwx------ 2 mysql mysql 4.0K Aug 15 10:36 mysql<br />srwxrwxrwx 1 mysql mysql    0 Aug 15 10:44 mysql.sock<br />drwx------ 2 mysql mysql 4.0K Aug 15 10:36 performance_schema<br />drwx------ 2 mysql mysql    6 Aug 15 10:36 test<br />drwx------ 2 mysql mysql 8.0K Aug 15 13:59 zabbix</pre></blockquote><div style="text-align: center;">▲ We can see the <i>ibdata1</i> filesize is very large.</div><a name='more'></a><br />My Environment:<br /><ul><li>CentOS: 7.3.1611</li><li>Kernel: 3.10.0-862.6.3</li><li>Zabbix: 3.2.6-1</li><li>MariaDB: 5.5.52-1</li><li>Apache: 2.4.6-45</li><li>PHP: 5.4.45</li></ul><br /><span class="Comment">※ The innodb_file-per-table option default is enabling after MySQL 5.6.6, but it’s not in this case.</span><br /><br /><h3>Stop the zabbix service</h3>Before my start, we need stop the zabbix-server service.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo systemctl stop zabbix-server <span class="Ctrl">[Enter]</span></blockquote><br /><h3>Backup the Database</h3>If the disk was full, please add the other storage, and mount to <i>/mnt/</i>, or someone path first.<br /><br />1. <b>Snapshot (Important)</b>: If this Zabbix server is built on Virtual Machine, please snapshot it. <b>If we get some problem, we can use this to quick recovery.</b><br /><br />2. Use the <i>mysqldump</i> command.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo su -c "mysqldump -u zabbix -p --all-databases --add-drop-table &gt; zabbix_db.sql" <span class="Ctrl">[Enter]</span><br /><br />[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ ls -lh zabbix_db.sql <span class="Ctrl">[Enter]</span><br />-rw-r--r-- 1 root root 6.3G Aug 15 03:43 zabbix_db.sql</blockquote><br />3. Backup the <i>/var/lib/mysql</i> directory.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo rsync -avP /var/lib/mysql /mnt/</blockquote><br /><h3>Enable the File-Per-Table tablespaces</h3>1. Stop the <b>MariaDB</b> service.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo systemctl stop mariadb <span class="Ctrl">[Enter]</span> </blockquote><br />2. Backup the <i>/etc/my.cnf</i>.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo cp /etc/my.cnf /etc/my.cnf.20180815 <span class="Ctrl">[Enter]</span></blockquote><br />3. Add <i>innodb_file_per_table=1</i> under <i>[mysqld]</i> in <i>/etc/my.cnf</i>.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo vim /etc/my.cnf <span class="Ctrl">[Enter]</span><br />[mysqld]<br />...<br /><br /><span class="Comment"># Enable the File-Per-Table tablespaces.</span><br />innodb_file_per_table=1</blockquote><br /><h3>Rebuild the Database</h3>Please make sure the backup is working, <b>this step will clean up all data</b>.<br /><br />1. Remove all files under <i>/var/lib/mysql/</i>. (I was tried only remove ib*, but it's not working.)<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo rm -rf /var/lib/mysql/* <span class="Ctrl">[Enter]</span></blockquote><br />2. Initialization the MySQL.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo /usr/bin/mysql_install_db <span class="Ctrl">[Enter]</span><br />Installing MariaDB/MySQL system tables in '/var/lib/mysql' ...<br />180815 10:36:15 [Note] /usr/libexec/mysqld (mysqld 5.5.52-MariaDB) starting as process 14533 ...<br />OK<br />Filling help tables...<br />180815 10:36:15 [Note] /usr/libexec/mysqld (mysqld 5.5.52-MariaDB) starting as process 14543 ...<br />OK<br /><br />To start mysqld at boot time you have to copy<br />support-files/mysql.server to the right place for your system<br /><br />PLEASE REMEMBER TO SET A PASSWORD FOR THE MariaDB root USER !<br />To do so, start the server, then issue the following commands:<br /><br />'/usr/bin/mysqladmin' -u root password 'new-password'<br />'/usr/bin/mysqladmin' -u root -h zabbix-server.example.tw password 'new-password'<br /><br />Alternatively you can run:<br />'/usr/bin/mysql_secure_installation'<br /><br />which will also give you the option of removing the test<br />databases and anonymous user created by default.  This is<br />strongly recommended for production servers.<br /><br />See the MariaDB Knowledgebase at http://mariadb.com/kb or the<br />MySQL manual for more instructions.<br /><br />You can start the MariaDB daemon with:<br />cd '/usr' ; /usr/bin/mysqld_safe --datadir='/var/lib/mysql'<br /><br />You can test the MariaDB daemon with mysql-test-run.pl<br />cd '/usr/mysql-test' ; perl mysql-test-run.pl<br /><br />Please report any problems at http://mariadb.org/jira<br /><br />The latest information about MariaDB is available at http://mariadb.org/.<br />You can find additional information about the MySQL part at:<br />http://dev.mysql.com<br />Support MariaDB development by buying support/new features from MariaDB<br />Corporation Ab. You can contact us about this at sales@mariadb.com.<br />Alternatively consider joining our community based development effort:<br />http://mariadb.com/kb/en/contributing-to-the-mariadb-project/</blockquote><br />3. List the database directory after we initialization.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ ls -lh /var/lib/mysql <span class="Ctrl">[Enter]</span><br /><pre>total 28K<br />-rw-rw---- 1 root root  16K Aug 15 10:36 aria_log.00000001<br />-rw-rw---- 1 root root   52 Aug 15 10:36 aria_log_control<br />drwx------ 2 root root 4.0K Aug 15 10:36 mysql<br />drwx------ 2 root root 4.0K Aug 15 10:36 performance_schema<br />drwx------ 2 root root    6 Aug 15 10:36 test</pre></blockquote><br />4. Change the file permission.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo chown -R mysql:mysql /var/lib/mysql/ <span class="Ctrl">[Enter]</span> </blockquote><br />5. List the database directory again.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ ls -l /var/lib/mysql <span class="Ctrl">[Enter]</span><br /><pre>total 28700<br />-rw-rw---- 1 mysql mysql    16384 Aug 15 10:36 aria_log.00000001<br />-rw-rw---- 1 mysql mysql       52 Aug 15 10:36 aria_log_control<br />-rw-rw---- 1 mysql mysql 18874368 Aug 15 10:41 ibdata1<br />-rw-rw---- 1 mysql mysql  5242880 Aug 15 10:41 ib_logfile0<br />-rw-rw---- 1 mysql mysql  5242880 Aug 15 10:40 ib_logfile1<br />drwx------ 2 mysql mysql     4096 Aug 15 10:36 mysql<br />drwx------ 2 mysql mysql     4096 Aug 15 10:36 performance_schema<br />drwx------ 2 mysql mysql        6 Aug 15 10:36 test</pre></blockquote><br />6. Start the MariaDB service.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ sudo systemctl start mariadb <span class="Ctrl">[Enter]</span></blockquote><br /><h4>Rebuild the account</h4>1. Login the MySQL shell with <i>root</i>, and switch to <i>mysql</i> database.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ mysql -u root -p <span class="Ctrl">[Enter]</span><br />Enter password:<br /><pre>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br />Your MariaDB connection id is 10<br />Server version: 5.5.52-MariaDB MariaDB Server<br /><br />Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.<br /><br />Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.<br /><br />MariaDB [(none)]&gt; use mysql;<br />Reading table information for completion of table and column names<br />You can turn off this feature to get a quicker startup with -A<br /><br />Database changed<br />MariaDB [mysql]&gt;</pre></blockquote><br />2. Change the database admin password.<br /><blockquote>MariaDB [mysql]&gt; UPDATE user SET Password=PASSWORD("&lt;FIXME&gt;") WHERE User="root";<br />Query OK, 4 rows affected (0.00 sec)<br />Rows matched: 4  Changed: 4  Warnings: 0</blockquote><br />3. Create a database for Zabbix.<br /><blockquote>MariaDB [mysql]&gt; CREATE DATABASE zabbix;<br />Query OK, 1 row affected (0.00 sec)</blockquote><br />4. Create a database account for Zabbix.<br /><blockquote>MariaDB [mysql]&gt; CREATE USER 'zabbix'@'localhost' IDENTIFIED BY '&lt;FIXME&gt;';<br />Query OK, 0 rows affected (0.00 sec)</blockquote><br />5. Setting permission of Zabbix account.<br /><blockquote>MariaDB [mysql]&gt; GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';<br />Query OK, 0 rows affected (0.00 sec)</blockquote><br />6. Immediately apply this permission.<br /><blockquote>MariaDB [mysql]&gt; FLUSH PRIVILEGES;<br />Query OK, 0 rows affected (0.00 sec)</blockquote><br /><h3>Verify the per_table setting</h3>Before we import before backup data, please verify the <i>innodb_file_per_table</i> value is ON.<br /><blockquote>MariaDB [mysql]&gt; show variables like '%per_table%';<br /><pre>+-----------------------+-------+<br />| Variable_name         | Value |<br />+-----------------------+-------+<br />| innodb_file_per_table | ON    |<br />+-----------------------+-------+<br />1 row in set (0.00 sec)<br /><br />MariaDB [mysql]&gt;</pre></blockquote><br /><h3>Recovery with import before backup sql file</h3><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ time mysql -u zabbix -p zabbix &lt; zabbix_db.sql <span class="Ctrl">[Enter]</span><br />Enter password:<br /><pre>real    31m57.704s<br />user    0m50.054s<br />sys     0m1.945s</pre></blockquote><br /><span class="Comment">※ It maybe need much time, we can drink coffee or do something else.</span><br /><br /><h3>Reduce the large table</h3>1. Find the large tables.<br /><blockquote>[ <span style="color: #ffdb00;">root</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br /># ls -lhtrS /var/lib/mysql/zabbix | tail <span class="Ctrl">[Enter]</span><br />...<br /><pre>-rw-rw---- 1 mysql mysql 192M Aug 15 14:01 events.ibd<br />-rw-rw---- 1 mysql mysql 288M Aug 15 14:01 trends.ibd<br />-rw-rw---- 1 mysql mysql 660M Aug 15 14:01 trends_uint.ibd<br />-rw-rw---- 1 mysql mysql 1.1G Aug 15 14:01 history.ibd<br />-rw-rw---- 1 mysql mysql  14G Aug 15 13:53 history_uint.ibd</pre></blockquote><br />2. Login the MySQl shell with zabbix, and switch to zabbix database.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ mysql -u zabbix -p <span class="Ctrl">[Enter]</span><br />Enter password:<br /><pre>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br />Your MariaDB connection id is 957<br />Server version: 5.5.52-MariaDB MariaDB Server<br /><br />Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.<br /><br />Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.<br /><br />MariaDB [(none)]&gt; use zabbix;<br />Reading table information for completion of table and column names<br />You can turn off this feature to get a quicker startup with -A<br /><br />Database changed</pre></blockquote><br />3. Count the <i>history_uint</i> table.<br /><blockquote>MariaDB [zabbix]&gt; select count(itemid) from history_uint;<br /><pre>+---------------+<br />| count(itemid) |<br />+---------------+<br />|     177487167 |<br />+---------------+<br />1 row in set (1 min 14.37 sec)</pre></blockquote><br />4. Clean up the <i>history_uint</i> table.<br /><blockquote>MariaDB [zabbix]&gt; truncate table history_uint;<br />Query OK, 0 rows affected (0.38 sec)</blockquote><br />5. Count the <i>history_uint</i> table again.<br /><blockquote>MariaDB [zabbix]&gt; select count(itemid) from history_uint;<br /><pre>+---------------+<br />| count(itemid) |<br />+---------------+<br />|           107 |<br />+---------------+<br />1 row in set (0.00 sec)</pre></blockquote><br />6. See the disk usage.<br /><blockquote>[ <span style="color: #ffdb00;">jonny</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br />$ df -h <span class="Ctrl">[Enter]</span><br /><pre>Filesystem           Size  Used Avail Use% Mounted on<br />/dev/mapper/cl-root   22G  5.1G   17G  24% /<br />devtmpfs             1.9G     0  1.9G   0% /dev<br />tmpfs                1.9G     0  1.9G   0% /dev/shm<br />tmpfs                1.9G  8.5M  1.9G   1% /run<br />tmpfs                1.9G     0  1.9G   0% /sys/fs/cgroup<br />/dev/vda1           1014M  322M  693M  32% /boot<br />tmpfs                379M     0  379M   0% /run/user/8002<br />/dev/vdb1             32G   23G  9.7G  70% /mnt</pre></blockquote><br />7. Find the large tables again.<br /><blockquote>[ <span style="color: #ffdb00;">root</span><span style="color: red;">@zabbix-server</span> <span style="color: #ad7fa8;">~</span> ]<br /># ls -lhtrS /var/lib/mysql/zabbix | tail <span class="Ctrl">[Enter]</span><br />...<br /><pre>-rw-rw---- 1 mysql mysql 192M Aug 15 14:01 events.ibd<br />-rw-rw---- 1 mysql mysql 288M Aug 15 14:01 trends.ibd<br />-rw-rw---- 1 mysql mysql 660M Aug 15 14:01 trends_uint.ibd<br />-rw-rw---- 1 mysql mysql 1.1G Aug 15 14:01 history.ibd</pre></blockquote><br />Good luck, have fun.<br /><br /><div style="text-align: center;"><span class="Comment">Synchronized on <a href="https://medium.com/@chusiang/change-the-mysql-innodb-tablespaces-to-file-per-table-for-zabbix-3-2-6-on-centos-7-dd86ab3179a4" target="_blank">Enabling the InnoDB File-Per-Table tablespaces and migrate the MySQL database for Zabbix 3.2.6 on CentOS 7 | Medium</a>.</span></div><br /><code class="ref">Reference:<br /><span style="color: #ffdb00;">★</span> <a href="https://hk.saowen.com/a/be12ba3c8e46982c00f09c7a8c26e772b8c69152e05d9d1d0e35f48bf8115d70" target="_blank">處理 MySQL 的 ibdata1 文檔過大問題 | 掃文資訊</a><br /><span style="color: #ffdb00;">★</span> <a href="https://dev.mysql.com/doc/refman/5.6/en/tablespace-enabling.html" target="_blank">[MySQL :: MySQL 5\.6 Reference Manual :: 14\.7\.4\.1 Enabling and Disabling File\-Per\-Table Tablespaces"</a><br /><span style="color: #ffdb00;">★</span> <a href="https://www.phpini.com/mysql/mysql-enable-innodb_file_per_table-convert-table" target="_blank">MySQL 開啟 innodb_file_per_table 及轉換現有資料表 | Linux 技術手札</a><br /><span style="color: #ffdb00;">★</span> <a href="https://www.phpini.com/mysql/mysql-add-new-users-databases-privileges" target="_blank">MySQL 新增使用者及建立資料庫權限 | Linux 技術手札</a><br /><span style="color: #ffdb00;">★</span> <a href="http://emn178.pixnet.net/blog/post/87659567-mysql%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A2%BC%E8%88%87%E5%BF%98%E8%A8%98%E5%AF%86%E7%A2%BC%E9%87%8D%E8%A8%AD" target="_blank">MySQL 修改密碼與忘記密碼重設 @ 小殘的程式光廊</a><br /></code><br />